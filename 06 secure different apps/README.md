# Защита различных типов приложений

В этой главе мы начнем с оценки того, является ли приложение, которое мы хотим защитить, внутренним или внешним. Затем мы рассмотрим, как защитить различные типы приложений, включая веб-, нативные и мобильные приложения. Мы также изучим, как защитить REST API и другие типы сервисов с помощью токенов-носителей (bearer tokens).

К концу этой главы вы узнаете принципы и лучшие практики защиты различных типов приложений. Вы поймете, как защищать веб-, мобильные и нативные приложения, а также как токены-носители могут использоваться для защиты любого типа сервиса, включая REST API, gRPC, WebSocket и другие типы сервисов.

## Основные темы:

- Понимание внутренних и внешних приложений
- Защита веб-приложений
- Защита нативных и мобильных приложений
- Защита REST API и сервисов

## Понимание внутренних и внешних приложений

При защите приложения первое, что нужно определить - является ли приложение внутренним или внешним.

**Внутренние приложения**, иногда называемые приложениями первой стороны, принадлежат компании. Не имеет значения, кто разработал приложение, и как оно размещено. Приложение может быть готовым решением или SaaS-приложением, но все равно считаться внутренним.

Для внутреннего приложения нет необходимости запрашивать у пользователя разрешение на доступ при аутентификации, поскольку это приложение доверенное, и администратор, зарегистрировавший приложение в Keycloak, может заранее одобрить доступ от имени пользователя. В Keycloak это делается путем отключения опции "Consent required" для клиента.

**Внешние приложения**, иногда называемые приложениями третьей стороны, не принадлежат и не управляются самой компанией, а скорее третьей стороной. Все внешние приложения должны иметь включенную опцию "Consent required".

## Защита веб-приложений

При защите веб-приложения с помощью Keycloak первое, что следует учитывать - это архитектура приложения:

- Является ли ваше веб-приложение традиционным серверным приложением или современным одностраничным приложением (SPA), работающим в браузере?
- Обращается ли приложение к каким-либо REST API, и если да, являются ли эти REST API частью приложения или внешними?

Если это SPA-приложение, вызывающее внешние API, то есть еще два варианта: приложение вызывает внешний REST API напрямую или через выделенный REST API, размещенный вместе с приложением.

На основе этого вы должны определить, какой из следующих вариантов соответствует архитектуре защищаемого приложения:

- Серверная сторона: если веб-приложение работает внутри веб-сервера или сервера приложений
- SPA с выделенным REST API: если приложение работает в браузере и вызывает только выделенный REST API в том же домене
- SPA с промежуточным API: если приложение работает в браузере и вызывает внешние REST API через промежуточный API, где промежуточный API размещен в том же домене, что и приложение
- SPA с внешним API: если приложение работает в браузере и вызывает только API, размещенные в разных доменах

### Общие рекомендации

Прежде всего, вы должны защищать свое веб-приложение с помощью потока авторизационного кода с расширением PKCE. Это предотвращает злоупотребление авторизационным кодом, если он перехвачен.

Настоятельно рекомендуется использовать библиотеку, а не реализовывать поддержку OAuth 2.0 и OpenID Connect самостоятельно.

При переносе существующих приложений для использования Keycloak может возникнуть соблазн сохранить страницы входа в существующем приложении, а затем обменивать имя пользователя и пароль на токены, используя Resource Owner Password Credential grant. Однако делать этого не следует.

Альтернативой может быть встраивание страницы входа Keycloak как iframe в приложение, но это также не рекомендуется.

Вместо этого приложение должно перенаправлять пользователя на доверенный поставщик удостоверений для аутентификации, особенно в сценариях единого входа (SSO).

## Защита серверных веб-приложений

При защите серверного веб-приложения с помощью Keycloak следует зарегистрировать конфиденциального клиента в Keycloak. Необходимо также настроить применимые URI перенаправления для клиента.

## Защита SPA с выделенным REST API

SPA, имеющее выделенный REST API в том же домене, должно защищаться с помощью Keycloak так же, как и серверное веб-приложение. Приложение должно использовать поток авторизационного кода с конфиденциальным клиентом для максимальной безопасности и использовать HTTP-сессию для защиты запросов API от клиентской части к выделенному REST API.

## Защита SPA с промежуточным REST API

Самый безопасный способ вызова внешних REST API из SPA - через промежуточный API, размещенный в том же домене, что и SPA. Этот подход часто называют шаблоном BFF (Backend for Frontend). Он обеспечивает повышенную безопасность, делает SPA более портативным и может упростить разработку.

## Защита SPA с внешним REST API

Самый простой способ защиты SPA с помощью Keycloak - использование потока авторизационного кода непосредственно из самого SPA с публичным клиентом, зарегистрированным в Keycloak. Это менее безопасный подход, поскольку токены, включая токен обновления, доступны непосредственно в браузере.

Для очень важных приложений, таких как финансовые приложения, этот подход использовать не стоит. Однако есть несколько методов, которые могут обеспечить хороший уровень безопасности для этого подхода:

- Использование короткого времени действия для токена обновления
- Ротация токенов обновления
- Использование расширения PKCE
- Хранение токенов в состоянии окна или HTML5 хранилище сессии
- Защита SPA от межсайтовых скриптинговых атак (XSS) и других атак
- Осторожное использование сторонних скриптов в приложении

## Защита нативных и мобильных приложений

Защита нативного или мобильного приложения с помощью Keycloak более сложна, чем защита веб-приложения. Для защиты нативного или мобильного приложения следует использовать поток авторизационного кода с расширением PKCE.

Эффективно это означает, что ваше нативное или мобильное приложение должно использовать браузер для аутентификации с Keycloak. Есть три варианта:

- Использование встроенного веб-просмотра
- Использование внешнего агента пользователя (браузера по умолчанию)
- Использование встроенного браузерного таба без приложения

Использование встроенного веб-просмотра не рекомендуется, поскольку оно уязвимо для перехвата учетных данных. Использование встроенного браузерного таба - это приемлемый подход.

## Защита REST API и сервисов

Когда приложение хочет вызвать REST API, защищенный Keycloak, оно сначала получает токен доступа от Keycloak, затем включает токен доступа в заголовок авторизации в запросах, которые отправляет на REST API.

Этот подход позволяет легко предоставить REST API, который может использоваться многими приложениями, даже сделать REST API доступным как публичный API в интернете для сторонних приложений.

Токены также могут использоваться для защиты других протоколов, таких как gRPC и WebSocket.
